/* =========================================================================
   SCENTS BY SARA - SHOP PAGE LOGIC
   Handles:
   - Variant Selection (Swatches & Size)
   - Filter Toggle & Logic
   - Sort Logic
   ========================================================================= */

document.addEventListener('DOMContentLoaded', () => {

    /* --- Variant Selection: Color Swatches --- */
    const swatches = document.querySelectorAll('.swatch');
    swatches.forEach(swatch => {
        swatch.addEventListener('click', (e) => {
            const parent = swatch.closest('.color-swatches');
            parent.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            swatch.classList.add('active');

            // In a real app, this would swap the product image
            // console.log(`Selected color: ${swatch.classList[1]}`);
        });
    });

    /* --- Variant Selection: Size Dropdown --- */
    const sizeSelectors = document.querySelectorAll('.size-dropdown');
    sizeSelectors.forEach(selector => {
        selector.addEventListener('click', (e) => {
            // Toggle a simple dropdown or cyclic selection for demo
            const sizes = ['SLIM', 'CURVY', 'PLUS-SIZE'];
            const currentSpan = selector.querySelector('span');
            const currentText = currentSpan.textContent.replace('SIZE: ', '');
            let nextIndex = (sizes.indexOf(currentText) + 1) % sizes.length;
            currentSpan.textContent = `SIZE: ${sizes[nextIndex]}`;

            // console.log(`Selected size: ${sizes[nextIndex]}`);
        });
    });

    /* --- Filter Button Logic --- */
    const filterBtn = document.querySelector('.filter-btn');
    const filterOverlay = document.createElement('div');
    filterOverlay.className = 'filter-overlay';
    filterOverlay.id = 'shop-filter-panel';
    filterOverlay.setAttribute('aria-hidden', 'true');
    filterOverlay.innerHTML = `
        <div class="filter-content container">
            <div class="filter-header flex-between mb-8">
                <h3 class="font-serif">FILTERS</h3>
                <button class="close-filters icon-btn">&times;</button>
            </div>
            <div class="filter-grid grid-cols-3">
                <div class="filter-group">
                    <h4>BODY SHAPE</h4>
                    <label><input type="checkbox" value="slim"> SLIM</label>
                    <label><input type="checkbox" value="curvy"> CURVY</label>
                    <label><input type="checkbox" value="plus-size"> PLUS SIZE</label>
                </div>
                <div class="filter-group">
                    <h4>SCENT</h4>
                    <label><input type="checkbox" value="vanilla"> VANILLA</label>
                    <label><input type="checkbox" value="lavender"> LAVENDER</label>
                </div>
                <div class="filter-group">
                    <h4>COLLECTION</h4>
                    <label><input type="checkbox" value="scar"> SCAR COLLECTION</label>
                    <label><input type="checkbox" value="sculpted"> SCULPTED COLLECTION</label>
                </div>
            </div>
            <div class="filter-footer mt-12 flex-between">
                <button class="btn-outline clear-filters">CLEAR ALL</button>
                <button class="btn-solid apply-filters">APPLY FILTERS</button>
            </div>
        </div>
    `;
    document.body.appendChild(filterOverlay);

    if (filterBtn) {
        filterBtn.addEventListener('click', () => {
            filterOverlay.classList.toggle('active');
            const isOpen = filterOverlay.classList.contains('active');
            filterBtn.setAttribute('aria-expanded', String(isOpen));
            filterOverlay.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
            document.body.style.overflow = filterOverlay.classList.contains('active') ? 'hidden' : '';
        });
    }

    const closeFilters = filterOverlay.querySelector('.close-filters');
    if (closeFilters) {
        closeFilters.addEventListener('click', () => {
            filterOverlay.classList.remove('active');
            if (filterBtn) filterBtn.setAttribute('aria-expanded', 'false');
            filterOverlay.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        });
    }

    const applyFiltersBtn = filterOverlay.querySelector('.apply-filters');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
            const selectedShapes = Array.from(filterOverlay.querySelectorAll('.filter-group:first-child input:checked')).map(i => i.value);
            filterProducts(selectedShapes);
            filterOverlay.classList.remove('active');
            if (filterBtn) filterBtn.setAttribute('aria-expanded', 'false');
            filterOverlay.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        });
    }

    const clearFiltersBtn = filterOverlay.querySelector('.clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            filterOverlay.querySelectorAll('input').forEach(i => i.checked = false);
            filterProducts([]);
        });
    }

    function filterProducts(shapes) {
        const cards = document.querySelectorAll('.shop-card');
        cards.forEach(card => {
            if (shapes.length === 0 || shapes.includes(card.dataset.category)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    /* --- Sort Dropdown Logic --- */
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
        sortSelect.addEventListener('change', () => {
            sortProducts(sortSelect.value);
        });
    }

    function sortProducts(order) {
        const grid = document.querySelector('.grid-cols-4');
        const cards = Array.from(grid.querySelectorAll('.shop-card'));

        cards.sort((a, b) => {
            const priceA = parseFloat(a.querySelector('.price-current').textContent.replace('£', ''));
            const priceB = parseFloat(b.querySelector('.price-current').textContent.replace('£', ''));
            return order === 'asc' ? priceA - priceB : priceB - priceA;
        });

        // Re-append in order
        cards.forEach(card => grid.appendChild(card));
    }

    /* --- Add to Cart Logic --- */
    const buyBtns = document.querySelectorAll('.btn-shop-now');
    buyBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const card = btn.closest('.shop-card');
            const name = card.querySelector('.product-name')?.textContent?.trim() || 'SHE IS TIMELESS';
            const priceText = card.querySelector('.price-current')?.textContent || '£0';
            const price = parseFloat(priceText.replace('£', '')) || 0;
            const size = (card.querySelector('.size-dropdown span')?.textContent || 'SIZE: SLIM')
                .replace('SIZE:', '')
                .trim();
            const image = card.querySelector('.product-image-wrap img')?.getAttribute('src') || 'assets/images/product-1.png';
            const activeSwatch = card.querySelector('.color-swatches .swatch.active');
            const color = activeSwatch?.classList.contains('swatch-tan') ? 'CARAMEL'
                : activeSwatch?.classList.contains('swatch-brown') ? 'EBONY'
                    : 'IVORY';

            if (window.CartState) {
                window.CartState.addItem({
                    id: `${name.toLowerCase().replace(/\s+/g, '-')}-${size.toLowerCase().replace(/\s+/g, '-')}`,
                    name,
                    price,
                    quantity: 1,
                    color,
                    size,
                    scent: 'VANILLA',
                    image,
                    url: 'product.html'
                });
            }

            // Simple visual feedback
            const originalText = btn.textContent;
            btn.textContent = 'ADDED TO BAG';
            btn.style.backgroundColor = 'var(--color-mocha)';
            btn.style.color = 'var(--color-sand)';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.backgroundColor = '';
                btn.style.color = '';
            }, 2000);
        });
    });
});
